# PyVM指令集文档

PyVM使用基于栈的虚拟机架构，所有操作都通过栈来完成。

## 指令格式

每条指令由操作码(opcode)和可选的操作数(operand)组成：

```
指令 = [操作码] [操作数]
```

操作码占用1字节，操作数根据指令类型可能占用1-4字节。

## 指令集列表

### 栈操作指令

| 指令码 | 助记符 | 操作数 | 描述 | 栈变化 |
|--------|--------|--------|------|---------|
| 0x00 | NOP | - | 空操作 | - |
| 0x01 | LOAD_CONST | index | 加载常量到栈顶 | → value |
| 0x02 | LOAD_VAR | index | 加载变量到栈顶 | → value |
| 0x03 | STORE_VAR | index | 将栈顶值存储到变量 | value → |
| 0x04 | POP | - | 弹出栈顶元素 | value → |
| 0x05 | DUP | - | 复制栈顶元素 | value → value, value |

### 算术运算指令

| 指令码 | 助记符 | 操作数 | 描述 | 栈变化 |
|--------|--------|--------|------|---------|
| 0x10 | ADD | - | 加法运算 | a, b → result |
| 0x11 | SUB | - | 减法运算 | a, b → result |
| 0x12 | MUL | - | 乘法运算 | a, b → result |
| 0x13 | DIV | - | 除法运算 | a, b → result |
| 0x14 | MOD | - | 取模运算 | a, b → result |
| 0x15 | NEG | - | 取负运算 | a → -a |

### 比较运算指令

| 指令码 | 助记符 | 操作数 | 描述 | 栈变化 |
|--------|--------|--------|------|---------|
| 0x20 | CMP_EQ | - | 相等比较 | a, b → bool |
| 0x21 | CMP_NE | - | 不等比较 | a, b → bool |
| 0x22 | CMP_LT | - | 小于比较 | a, b → bool |
| 0x23 | CMP_LE | - | 小于等于比较 | a, b → bool |
| 0x24 | CMP_GT | - | 大于比较 | a, b → bool |
| 0x25 | CMP_GE | - | 大于等于比较 | a, b → bool |

### 控制流指令

| 指令码 | 助记符 | 操作数 | 描述 | 栈变化 |
|--------|--------|--------|------|---------|
| 0x30 | JUMP | offset | 无条件跳转 | - |
| 0x31 | JUMP_IF_FALSE | offset | 条件跳转(假) | bool → |
| 0x32 | JUMP_IF_TRUE | offset | 条件跳转(真) | bool → |
| 0x33 | CALL | argc | 函数调用 | args... → result |
| 0x34 | RETURN | - | 函数返回 | result → |

### 内置函数指令

| 指令码 | 助记符 | 操作数 | 描述 | 栈变化 |
|--------|--------|--------|------|---------|
| 0x40 | PRINT | - | 打印栈顶值 | value → |
| 0x41 | INPUT | - | 读取输入 | → value |

### 程序控制指令

| 指令码 | 助记符 | 操作数 | 描述 | 栈变化 |
|--------|--------|--------|------|---------|
| 0xFF | HALT | - | 程序结束 | - |

## 指令编码示例

### 加载常量
```
LOAD_CONST 5    # 加载常量5
编码: 01 05
```

### 变量赋值
```
LOAD_CONST 10   # 加载常量10
STORE_VAR 0     # 存储到变量0
编码: 01 0A 03 00
```

### 算术运算
```
LOAD_VAR 0      # 加载变量0
LOAD_VAR 1      # 加载变量1
ADD             # 相加
编码: 02 00 02 01 10
```

### 条件跳转
```
LOAD_VAR 0      # 加载变量0
LOAD_CONST 5    # 加载常量5
CMP_GT          # 比较大于
JUMP_IF_FALSE 10 # 如果为假跳转到偏移10
编码: 02 00 01 05 24 31 0A
```

## 数据类型

PyVM支持以下基本数据类型：

- **整数(int)**: 32位有符号整数
- **浮点数(float)**: 64位双精度浮点数
- **布尔值(bool)**: true/false
- **字符串(string)**: UTF-8编码字符串

## 内存布局

### 常量池
存储编译时确定的常量值，通过索引访问。

### 变量表
存储局部变量和全局变量，通过索引访问。

### 执行栈
用于计算和临时存储的栈结构。
